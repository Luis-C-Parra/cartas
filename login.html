<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - TELEFUNKEN FAMILIAR</title>
    <link href="style.css" rel="stylesheet" /> 
</head>
<body class="auth-body">
    <div class="auth-container">
        <div class="auth-box" id="login-box">
            <h2>üëã Iniciar Sesi√≥n</h2>
            
            <div style="text-align: center; margin-bottom: 25px;">
                <p style="margin-bottom: 10px; font-weight: 600; color: #555;">¬øNecesitas el Usuario y Contrase√±a?</p>
                <a 
    href="https://wa.me/5491162841533?text=Hola,%20solicito%20ingreso%20al%20juego.%20Usuario%20preferido/otorgado:%20[Esperando%20respuesta]" 
    target="_blank" 
    class="whatsapp-btn"
>
    üü¢ Solicitar Acceso por WhatsApp
</a>
            </div>
            <form id="login-form">
                <div class="input-group">
                    <label for="login-user">üë§ Usuario:</label>
                    <input type="text" id="login-user" required>
                </div>
                <div class="input-group">
                    <label for="login-pass">üîí Contrase√±a:</label>
                    <input type="password" id="login-pass" required>
                </div>
                <button type="submit" class="auth-button">Entrar al Juego</button>
            </form>
        </div>

        <div id="auth-message" class="message-box" style="display: none;"></div>
    </div>

    <script>
    // üö® 2. PEGA AQU√ç LA URL COMPLETA DE LA APLICACI√ìN WEB DE APPS SCRIPT
    const API_URL = 'https://script.google.com/macros/s/AKfycbxNWqM-pJX1PMIa6Kk5X-GPPXt0cEN7uMiSMXVAnmnbo3AhkpEKKzDK2iDmsP3dUnY5Xg/exec'; 
                     
    const LOGIN_KEY = "isLoggedIn"; 

    // Mantiene las funciones de mensaje (asumiendo que las tienes en el HTML)
    function displayMessage(msg, type) {
        const msgBox = document.getElementById('auth-message');
        msgBox.innerText = msg;
        msgBox.className = `message-box ${type}`;
        msgBox.style.display = 'block';
    }

    // NUEVA FUNCI√ìN: Muestra el mensaje de carga y deshabilita el bot√≥n
    function showLoadingMessage() {
        const form = document.getElementById('login-form');
        const button = form.querySelector('.auth-button');
        
        displayMessage("üîÑ Comparando credenciales en la base de datos...", 'loading');
        button.disabled = true; // Deshabilita el bot√≥n para evitar clics dobles
    }
    
    // NUEVA FUNCI√ìN: Oculta el mensaje de carga y habilita el bot√≥n
    function hideLoadingMessage() {
        const form = document.getElementById('login-form');
        const button = form.querySelector('.auth-button');
        
        // La funci√≥n displayMessage ya maneja si se muestra √©xito o error
        button.disabled = false; // Habilita el bot√≥n
    }

    document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('login-user').value.trim();
        const password = document.getElementById('login-pass').value;

        // 1. Mostrar mensaje de carga inmediatamente
        showLoadingMessage(); 

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' }, 
                body: JSON.stringify({ username, password })
            });
            
            // Si hay un error de red o HTTP (ej. 404, 500)
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const data = await response.json(); 

            // 2. Ocultar el mensaje de carga antes de mostrar el resultado final
            // NOTA: No llamamos a hideLoadingMessage() aqu√≠, lo haremos al final del bloque try/catch.

            if (data.success) {
        localStorage.setItem(LOGIN_KEY, 'true');
        
        // üö® CAMBIO AQU√ç: GUARDAMOS EL NOMBRE DE USUARIO
        localStorage.setItem('currentUser', username.toUpperCase()); 
        
        displayMessage(`ü•≥ ¬°Bienvenido, ${username.toUpperCase()}! Redirigiendo...`, 'success');
        
        setTimeout(() => { window.location.href = 'index.html'; }, 1000);

            } else {
                displayMessage(`‚ùå Error de Login: ${data.message}`, 'error');
                localStorage.removeItem(LOGIN_KEY);
            }
        } catch (error) {
            console.error('Fetch error:', error);
            displayMessage("‚ùå Error de conexi√≥n con el servicio. Verifique la URL de la API.", 'error');
            localStorage.removeItem(LOGIN_KEY);
        } finally {
             // 3. Asegurar que el bot√≥n se habilite de nuevo (si no hubo redirecci√≥n)
             hideLoadingMessage(); 
        }
    });
</script>
</body>

</html>
